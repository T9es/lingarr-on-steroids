import{d as A,m as W,r as u,c as G,w as H,f as J,q as Q,e as r,k as e,b as l,x as m,j as t,g as n,L as C,Q as R,F as D,y as O,C as z,D as E,n as K}from"./index-Ch4LkV9I.js";import{u as X}from"./useDebounce--iKAfTly.js";import{_ as Y}from"./PageLayout.vue_vue_type_script_setup_true_lang-Brc2-CeY.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./TimesIcon-BnWx0jvB.js";import"./useClickOutside-CMGy5ibi.js";const Z={class:"w-full p-4"},ee={class:"bg-tertiary mb-4 rounded-lg p-4"},te={class:"text-2xl font-bold"},se={class:"text-secondary-content text-sm mt-1"},ae={class:"bg-secondary rounded-lg p-4 mb-4"},oe={class:"text-lg font-semibold mb-3"},ne={class:"mb-4"},re={class:"block text-sm font-medium mb-1"},le=["placeholder","disabled"],ie={class:"text-secondary-content mt-1 text-xs"},ce={key:0,class:"text-error mt-1 text-xs"},de={key:0,class:"mb-4 rounded border border-accent/40 bg-tertiary"},ue={class:"border-secondary/40 flex items-center justify-between border-b px-3 py-2 text-xs text-secondary-content"},pe={key:0,class:"text-[10px] uppercase tracking-wide"},me={class:"max-h-64 divide-y divide-secondary/40 overflow-y-auto"},ve={class:"text-sm font-semibold"},he={class:"text-secondary-content mb-2 text-xs"},ge={class:"flex flex-wrap gap-2"},be=["onClick"],xe={key:0,class:"text-primary-content/70"},ye={key:1,class:"mb-4 text-xs text-secondary-content"},_e={class:"mb-4"},fe={class:"block text-sm font-medium mb-1"},Te=["placeholder","disabled"],we={key:0,class:"text-secondary-content mt-1 text-xs"},ke={class:"grid grid-cols-2 gap-4 mb-4"},Se={class:"block text-sm font-medium mb-1"},Ce=["disabled"],Re={class:"block text-sm font-medium mb-1"},Le=["disabled"],$e={class:"flex gap-2"},De=["disabled"],Oe={class:"text-lg font-semibold mb-2"},Ue={class:"text-sm"},Ee={key:0,class:"text-error"},Fe={key:1},Ne={key:2},Ie={class:"bg-secondary rounded-lg overflow-hidden"},Me={class:"bg-tertiary flex items-center justify-between px-4 py-2"},Pe={class:"text-sm font-semibold"},Ve={key:0,class:"flex h-full items-center justify-center text-gray-500"},je={class:"text-gray-400 mr-2"},Be={key:0,class:"text-xs text-gray-500 ml-4 whitespace-pre-wrap"},Ke=A({__name:"TranslationTestPage",setup(qe){const{translate:a}=W(),y=u(""),_=u("en"),f=u(""),v=u(!1),h=u([]),d=u(null),T=u(null),w=u(""),g=u([]),b=u(!1),x=u(null),k=u(null);let L="";const U=G(()=>y.value.trim()!==""&&_.value.trim()!==""&&f.value.trim()!=="");function F(i){return new Date(i).toLocaleTimeString()}function N(i){switch(i.toUpperCase()){case"ERROR":return"text-red-500";case"WARNING":return"text-orange-500";case"INFORMATION":return"text-green-500";default:return"text-blue-500"}}function I(){h.value=[],d.value=null}const M=X(async i=>{const o=i.trim(),s=`${Date.now()}-${o}`;if(L=s,o.length<2){g.value=[],x.value=null,b.value=!1;return}b.value=!0,x.value=null;try{const c=await fetch(`/api/test-translation/search?query=${encodeURIComponent(o)}`);if(!c.ok)throw new Error(`Search failed with status ${c.status}`);const S=await c.json();if(s!==L)return;g.value=S}catch(c){x.value=c instanceof Error?c.message:"Failed to search media for test translation.",g.value=[]}finally{s===L&&(b.value=!1)}},300);H(()=>w.value,i=>{if(!i){g.value=[],x.value=null,b.value=!1,k.value=null;return}M(i)});function P(i,o){y.value=o.path,o.language&&o.language.trim()!==""&&(_.value=o.language);const s=o.language?o.language.toUpperCase():"??",c=o.caption?o.caption.toUpperCase():"";k.value=c?`${i.displayTitle} • ${s} • ${c}`:`${i.displayTitle} • ${s}`}async function V(){await K(),T.value&&(T.value.scrollTop=T.value.scrollHeight)}async function j(){if(!(!U.value||v.value)){v.value=!0,d.value=null,h.value=[];try{const o=(await fetch("/api/test-translation/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subtitlePath:y.value,sourceLanguage:_.value,targetLanguage:f.value})})).body?.getReader(),s=new TextDecoder;if(!o)throw new Error("Failed to get response reader");for(;;){const{done:c,value:S}=await o.read();if(c)break;const q=s.decode(S).split(`
`).filter($=>$.startsWith("data: "));for(const $ of q)try{const p=JSON.parse($.substring(6));p.type==="log"?(h.value.push({level:p.Level,message:p.Message,timestamp:p.Timestamp,details:p.Details}),V()):p.type==="result"&&(d.value={success:p.Success,errorMessage:p.ErrorMessage,totalSubtitles:p.TotalSubtitles,translatedCount:p.TranslatedCount,duration:p.Duration})}catch{}}}catch(i){h.value.push({level:"ERROR",message:`Connection error: ${i instanceof Error?i.message:"Unknown error"}`,timestamp:new Date().toISOString()})}finally{v.value=!1}}}async function B(){try{await fetch("/api/test-translation/cancel",{method:"POST"}),h.value.push({level:"WARNING",message:"Cancel request sent...",timestamp:new Date().toISOString()})}catch(i){h.value.push({level:"ERROR",message:`Failed to cancel: ${i instanceof Error?i.message:"Unknown error"}`,timestamp:new Date().toISOString()})}}return(i,o)=>(r(),J(Y,null,{default:Q(()=>[e("div",Z,[e("div",ee,[e("h1",te,t(n(a)("translationTest.title")),1),e("p",se,t(n(a)("translationTest.description")),1)]),e("div",ae,[e("h2",oe,t(n(a)("translationTest.configuration")),1),e("div",ne,[e("label",re,t(n(a)("translationTest.searchMedia")),1),C(e("input",{"onUpdate:modelValue":o[0]||(o[0]=s=>w.value=s),type:"text",placeholder:n(a)("translationTest.searchPlaceholder"),class:"bg-primary border-accent w-full rounded border px-3 py-2 text-sm",disabled:v.value},null,8,le),[[R,w.value]]),e("p",ie,t(n(a)("translationTest.searchHelp")),1),x.value?(r(),l("p",ce,t(x.value),1)):m("",!0)]),g.value.length?(r(),l("div",de,[e("div",ue,[e("span",null,t(n(a)("translationTest.searchResultsTitle")),1),b.value?(r(),l("span",pe,t(n(a)("common.loading")),1)):m("",!0)]),e("div",me,[(r(!0),l(D,null,O(g.value,s=>(r(),l("div",{key:`${s.mediaType}-${s.mediaId}`,class:"px-3 py-2"},[e("p",ve,t(s.displayTitle),1),e("p",he,t(s.mediaType==="Movie"?n(a)("movies.title"):n(a)("tvShows.episode")),1),e("div",ge,[(r(!0),l(D,null,O(s.subtitles,c=>(r(),l("button",{key:c.path,type:"button",class:"border-accent hover:bg-accent cursor-pointer rounded border px-2 py-1 text-xs text-primary-content transition-colors",onClick:S=>P(s,c)},[z(t(c.language.toUpperCase()||"??")+" ",1),c.caption?(r(),l("span",xe," - "+t(c.caption.toUpperCase()),1)):m("",!0)],8,be))),128))])]))),128))])])):w.value.trim().length>=2&&!b.value?(r(),l("div",ye,t(n(a)("translationTest.noSearchResults")),1)):m("",!0),e("div",_e,[e("label",fe,t(n(a)("translationTest.subtitlePath")),1),C(e("input",{"onUpdate:modelValue":o[1]||(o[1]=s=>y.value=s),type:"text",placeholder:n(a)("translationTest.subtitlePathPlaceholder"),class:"bg-primary border-accent w-full rounded border px-3 py-2 text-sm",disabled:v.value},null,8,Te),[[R,y.value]]),k.value?(r(),l("p",we,t(n(a)("translationTest.selectedFromSearch"))+" "+t(k.value),1)):m("",!0)]),e("div",ke,[e("div",null,[e("label",Se,t(n(a)("translationTest.sourceLanguage")),1),C(e("input",{"onUpdate:modelValue":o[2]||(o[2]=s=>_.value=s),type:"text",placeholder:"en",class:"bg-primary border-accent w-full rounded border px-3 py-2 text-sm",disabled:v.value},null,8,Ce),[[R,_.value]])]),e("div",null,[e("label",Re,t(n(a)("translationTest.targetLanguage")),1),C(e("input",{"onUpdate:modelValue":o[3]||(o[3]=s=>f.value=s),type:"text",placeholder:"pl",class:"bg-primary border-accent w-full rounded border px-3 py-2 text-sm",disabled:v.value},null,8,Le),[[R,f.value]])])]),e("div",$e,[v.value?(r(),l("button",{key:1,class:"bg-error hover:bg-error/80 cursor-pointer rounded px-4 py-2 text-sm font-medium text-white transition",onClick:B},t(n(a)("translationTest.cancel")),1)):(r(),l("button",{key:0,class:"bg-accent hover:bg-accent/80 cursor-pointer rounded px-4 py-2 text-sm font-medium text-white transition",disabled:!U.value,onClick:j},t(n(a)("translationTest.startTest")),9,De))])]),d.value?(r(),l("div",{key:0,class:E(["rounded-lg p-4 mb-4",d.value.success?"bg-success/20 border border-success":"bg-error/20 border border-error"])},[e("h2",Oe,t(d.value.success?n(a)("translationTest.success"):n(a)("translationTest.failed")),1),e("div",Ue,[d.value.errorMessage?(r(),l("p",Ee,t(d.value.errorMessage),1)):m("",!0),d.value.totalSubtitles?(r(),l("p",Fe,t(n(a)("translationTest.translated"))+": "+t(d.value.translatedCount)+"/"+t(d.value.totalSubtitles),1)):m("",!0),d.value.duration?(r(),l("p",Ne,t(n(a)("translationTest.duration"))+": "+t(d.value.duration.toFixed(1))+"s ",1)):m("",!0)])],2)):m("",!0),e("div",Ie,[e("div",Me,[e("h2",Pe,t(n(a)("translationTest.logs")),1),e("button",{class:"bg-warning hover:bg-warning/80 cursor-pointer rounded px-2 py-1 text-xs text-white transition",onClick:I},t(n(a)("translationTest.clearLogs")),1)]),e("div",{ref_key:"logContainer",ref:T,class:"bg-primary h-[40vh] overflow-y-auto font-mono text-xs p-2"},[h.value.length===0?(r(),l("div",Ve,t(n(a)("translationTest.waitingForLogs")),1)):m("",!0),(r(!0),l(D,null,O(h.value,(s,c)=>(r(),l("div",{key:c,class:"py-1 border-b border-secondary/30"},[e("span",je,t(F(s.timestamp)),1),e("span",{class:E([N(s.level),"mr-2 font-semibold"])}," ["+t(s.level)+"] ",3),e("span",null,t(s.message),1),s.details?(r(),l("div",Be,t(s.details),1)):m("",!0)]))),128))],512)])])]),_:1}))}});export{Ke as default};
